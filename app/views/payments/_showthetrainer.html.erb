<% unless current_user.rolable.bank_href.blank? %>

<!-- tentative form to add plans -->

<% if false %>

<%= form_tag plans_path(current_user.rolable.id), remote: true, method: :post do %>
  <%= text_field_tag :name, nil %>
  <%= text_field_tag :amount, nil %>

  <%= submit_tag "Add Plan", class: "btn mybtn btn-large btn-primary" %>
<% end %>

<% end %>

<!-- end tentative form to add plans-->


 <% unless current_user.rolable.default_price.blank? %>

    <div style="border-bottom: dotted 1px lightgray; padding-bottom: 18px; margin-bottom: 18px;">
      <% @cost = current_user.rolable.default_price.to_f/100 %>
      <h3>Current Price Per Training Session</h3>
      <h5><%= number_to_currency(@cost) %></h5>
    </div>

    <div style="border-bottom: dotted 1px lightgray; padding-bottom: 22px; margin-bottom: 15px;">

      <h5 style="padding-bottom:6px;">Change Price Per Session</h5>

       <%= form_tag payments_add_default_price_path, remote: true, method: :post do %>
            <div class="price">
              <%= text_field_tag :default_price, nil, :class => "form-control numberOnly", :style => "max-width:159px;text-align:center;margin-bottom:15px;" %>
            </div>

            <%= submit_tag "Change Default Price", class: "btn mybtn btn-large btn-primary" %>
          <% end %>
      <% else %>

      <div style="border-bottom: dotted 1px lightgray; padding-bottom: 22px; margin-bottom: 15px;">

      <h5 style="padding-bottom:6px;">Set Price Per Session</h5>

          <%= form_tag payments_add_default_price_path, remote: true, method: :post do %>
            <div class="price">
              <%= text_field_tag :default_price, nil, :class => "form-control numberOnly", :style => "max-width:159px;text-align:center;margin-bottom:15px;" %>
            </div>

            <%= submit_tag "Add Default Price", class: "btn mybtn btn-large btn-primary" %>
          <% end %>

      <% end %>

    </div>


    <div style="">

       <h5>If you would like to stop accepting payments or change your bank account details, click the button below to remove your current bank account.</h5>

      <p><%= button_to "Remove My Bank Account", payments_delete_trainer_bank_path, method: :post, remote: true, class: "btn mybtn btn-large btn-primary deleteMe" %></p>

    </div>


<% else %>

<div style="max-width:700px;">

<h2 style="font-size: 28px;">To get started, we need just a few details from you.</h2>
<h5 style="font-weight: 200; margin-bottom: 20px; margin-top: 12px;max-width:650px;">After that, when you make a sale on Personal Trainer Labs, we'll deposit the funds directly to your bank account.  Typically, the funds will be available the next business day, excluding bank observed holidays.</h5>

<form role="form">
  <h2 style="background:#F0F1F2;padding: 8px 15px 8px;margin-bottom:25px;font-size: 26px;">About You</h2>


  <div class="form-group" style="clear:both;border-bottom: dotted 1px lightgray; padding-bottom: 10px;">
    <label style="max-width: 153px;height: 34px;float: left; padding-top: 12px;margin-right: 30px;">Account Holder's Name</label>
    <input type="text" class="form-control" style="max-width:220px;text-align:center;" id="ba-name" autocomplete="off" placeholder="" />
    <label style="color: rgba(97, 97, 97, 0.58); font-size: 11px; font-weight: normal;">Full Legal Name</label>
  </div>
  <div class="form-group" style="clear:both;border-bottom: dotted 1px lightgray; padding-bottom: 15px;">
    <label style="max-width: 153px;height: 34px;float: left; padding-top: 12px;margin-right: 92px;">Date of Birth</label>
    <div style="width: 220px; display: inline-block;">
      <input type="text" class="form-control" style="max-width:60px;display:inline-block;text-align:center;" id="date-of-birth-month" autocomplete="off" placeholder="MM" /> /
      <input type="text" class="form-control" style="max-width:60px;display:inline-block;text-align:center;" autocomplete="off" placeholder="DD" /> /
      <input type="text" class="form-control" style="max-width:80px;display:inline-block;text-align:center;" id="date-of-birth-year" autocomplete="off" placeholder="YYYY" />
    </div>
  </div>
  <div class="form-group" style="clear:both;border-bottom: dotted 1px lightgray; padding-bottom: 10px;">
    <label style="max-width: 153px;height: 34px;float: left; padding-top: 12px;margin-right: 66px;">Last Four of SSN</label>
    <div style="width: 307px; display: inline-block;">
      <input type="text" class="form-control" style="max-width:80px;text-align:center;" id="L4-SSN" autocomplete="off" placeholder="" />
      <label style="color: rgba(97, 97, 97, 0.58); font-size: 11px; font-weight: normal;">Used to verify your identity. No credit checks will be performed.</label>
    </div>
  </div>
  <div class="form-group" style="clear:both;border-bottom: dotted 1px lightgray; padding-bottom: 10px;">
    <label style="max-width: 153px;height: 34px;float: left; padding-top: 12px;margin-right: 78px;">Street Address</label>
    <input type="text" class="form-control" style="max-width:220px;text-align:center;" id="St-Addr" autocomplete="off" placeholder="" />
    <label style="color: rgba(97, 97, 97, 0.58); font-size: 11px; font-weight: normal;">Just the street address; don't include the city or state.</label>
  </div>
  <div class="form-group" style="clear:both;border-bottom: dotted 1px lightgray; padding-bottom: 10px;display:none;">
    <label style="max-width: 153px;height: 34px;float: left; padding-top: 12px;margin-right: 82px;text-align:center;">Country Code</label>
    <input type="text" class="form-control" style="max-width:220px" id="C-Code" autocomplete="off" placeholder="" value="USA" />
  </div>
  <div class="form-group" style="clear:both;border-bottom: dotted 1px lightgray; padding-bottom: 15px;">
    <label style="max-width: 153px;height: 34px;float: left; padding-top: 12px;margin-right: 110px;">Zip Code</label>
      <div style="width: 220px; display: inline-block;">
      <input type="text" class="form-control" style="max-width:100px;text-align:center;" id="postal_code" autocomplete="off" placeholder="" />
    </div>
  </div>
  <div class="form-group" style="clear:both;">
    <label style="max-width: 153px;height: 34px;float: left; padding-top: 12px;margin-right: 75px;">Phone Number</label>
    <input type="text" class="form-control" style="max-width:220px;text-align:center;" id="Phone-Num" autocomplete="off" placeholder="" />
  </div>
  <h2 style="background:#F0F1F2;padding: 8px 15px 8px;margin-bottom: 25px; margin-top: 25px;font-size: 26px;">Bank Account Information</h2>

  <div style="max-width:290px; display:inline-block">
  <div class="form-group" style="clear:both;border-bottom: dotted 1px lightgray; padding-bottom: 0px;margin-top:-10px;margin-bottom:0px;">
    <label style="max-width: 153px;height: 34px;float: left; padding-top: 12px;margin-right: 66px;">Routing Number</label>
    <input type="text" class="form-control" style="max-width:220px;text-align:center;" id="ba-routing" autocomplete="off" placeholder="" />
    <label style="color: rgba(97, 97, 97, 0.58); font-size: 11px; font-weight: normal;">9-digits</label>
  </div>
  <div class="form-group" style="clear:both;border-bottom: dotted 1px lightgray; padding-bottom: 0px;margin-bottom:0px;">
    <label style="max-width: 153px;height: 34px;float: left; padding-top: 12px;margin-right: 64px;">Account Number</label>
    <input type="text" class="form-control" style="max-width:220px;text-align:center;margin-bottom:12px;" id="ba-number" autocomplete="off" placeholder="" />
  </div>
  <div class="form-group" style="clear:both;">
    <label style="max-width: 153px;height: 34px;float: left; padding-top: 12px;margin-right: 15px">Confirm Account Number</label>
    <input type="text" class="form-control" style="max-width:220px;text-align:center;" id="ba-number2" autocomplete="off" placeholder="" />
  </div>

  </div>
  <div class="balanced-check" style="height: 205px; width: 404px;display: inline-block;"></div>


  <a id="ba-submit" class="btn btn-primary" style="margin-top:20px;width:141px;display:block;">Add Bank Account</a>
</form>


</div>

<% end %>

<script type="text/javascript">

function handleResponse(response) {
  if (response.status_code == 201) {
    console.log(response)
    var phone = $('#Phone-Num').val().replace(/\s+/g, "").replace(/\(|\)/g, "").replace(/-/g, "");
    var fundingInstrument = response.cards != null ? response.cards[0] : response.bank_accounts[0];
    // Call your backend
    jQuery.post("<%= payments_verify_trainer_bank_path %>", {
      uri: fundingInstrument.href,
      last4ssn: $('#L4-SSN').val(),
      phonenum: phone,
      doby: $('#date-of-birth-year').val(),
      dobm: $('#date-of-birth-month').val(),
      postal_code: $('#postal_code').val(),
      country_code: $('#C-Code').val(),
      street_address: $('#St-Addr').val(),
      holder_name: $('#ba-name').val(),
    }, function(r) {
      // Check your backend response
      if (r.status === 201) {
        // Your successful logic here from backend
      } else {
      // Your failure logic here from backend
      }
    });
  } else {
    // Failed to tokenize, your error logic here
    
    var myStringArray = response.errors;
    var arrayLength = myStringArray.length;
    for (var i = 0; i < arrayLength; i++) {
        var descrip = myStringArray[i].description.split(" - ")
        console.log(descrip[1]);

        //Do something
        
    }
    console.log(response)
    jQuery.post("<%= payments_form_validation_path %>");
  }
}

$('#ba-submit').click(function (e) {
  e.preventDefault();


  var routing = $('#ba-routing').val().replace(/\s+/g,"");
  var account = $('#ba-number').val().replace(/\s+/g, "");
  var account2 = $('#ba-number2').val().replace(/\s+/g, "")

  if (account == account2) {

    var payload = {
      name: $('#ba-name').val(),
      routing_number: routing,
      account_number: account,
    };


    // Create bank account
    balanced.bankAccount.create(payload, handleResponse);


  } else {

    jQuery.post("<%= payments_account_not_matching_path %>");

  }

});


$('#Phone-Num').formatter({
  'pattern': '({{999}}) {{999}} - {{9999}}',
  'persistent': false
});

$('#ba-routing').formatter({
  'pattern': '{{999}}  {{999}}  {{999}}',
  'persistent': false
});

$('#ba-number').formatter({
  'pattern': '{{999}}  {{999}}  {{999}}  {{9999}}',
  'persistent': false
});

$('#ba-number2').formatter({
  'pattern': '{{999}}  {{999}}  {{999}}  {{9999}}',
  'persistent': false
});

</script>